
# å‰ç«¯åŸºå»ºï¼šä½¿ç”¨plus apiå®ç°appé€šçŸ¥æƒé™ç®¡ç†


## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½èƒŒæ™¯](#åŠŸèƒ½èƒŒæ™¯)
- [ç»„ä»¶åŠŸèƒ½ä»‹ç»](#ç»„ä»¶åŠŸèƒ½ä»‹ç»)
- [è®¾è®¡æ€è·¯](#è®¾è®¡æ€è·¯)
- [æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹](#æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹)
- [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
- [ä½¿ç”¨æ¡ˆä¾‹](#ä½¿ç”¨æ¡ˆä¾‹)
- [å®Œæ•´ä»£ç ](#å®Œæ•´ä»£ç )

---

## åŠŸèƒ½èƒŒæ™¯

å½“å‰é¡¹ç›®ä½¿ç”¨uniapp + webview æ··åˆå¼€å‘ï¼Œç³»ç»Ÿäº¤äº’èƒ½åŠ›ä¸»è¦é€šè¿‡html5è”ç›Ÿæ ‡å‡†plus apiå®ç°ï¼Œappé¡¹ç›®ä¸­æ¶‰åŠåˆ°appé€šçŸ¥æ¨é€åŠŸèƒ½çš„å¼€å‘ï¼Œéœ€è¦åœ¨ç”¨æˆ·è®¢é˜…ç›¸å…³åŠŸèƒ½åï¼Œå¼•å¯¼ç”¨æˆ·å¼€å¯é€šçŸ¥æƒé™ï¼›ä¸»è¦æ¶‰åŠä¸¤ä¸ªåŠŸèƒ½ï¼š
1. æ£€æŸ¥é€šçŸ¥æƒé™æ˜¯å¦å¼€å¯
2. å¦‚æœæœªå¼€å¯ï¼Œåˆ™å¼•å¯¼ç”¨æˆ·æ‰“å¼€ç³»ç»Ÿè®¾ç½®


### å¼€å‘éš¾ç‚¹

1. **è·¨å¹³å°å…¼å®¹æ€§é—®é¢˜**
    - Androidå’ŒiOSç³»ç»Ÿçš„æƒé™æ£€æµ‹æœºåˆ¶å®Œå…¨ä¸åŒ
    - ä¸åŒç‰ˆæœ¬çš„ç³»ç»ŸAPIå˜åŒ–è¾ƒå¤§

2. **ç‰ˆæœ¬é€‚é…å¤æ‚**
    - iOS 18.5+ å¯¹URL Schemeçš„é™åˆ¶æ›´åŠ ä¸¥æ ¼
    - Androidä¸åŒç‰ˆæœ¬çš„Intentè·³è½¬æ–¹å¼ä¸åŒ

3. **ç”¨æˆ·ä½“éªŒè¦æ±‚**
    - éœ€è¦æä¾›ä¾¿æ·çš„æƒé™è®¾ç½®å…¥å£
    - æƒé™è¢«æ‹’ç»æ—¶éœ€è¦å‹å¥½çš„å¼•å¯¼æ–¹å¼
4. **appæŠ€æœ¯æ ˆé™åˆ¶**
    - uniapp + webview æ··åˆå¼€å‘
    - ç³»ç»Ÿäº¤äº’èƒ½åŠ›ä¸»è¦é€šè¿‡html5è”ç›Ÿæ ‡å‡†plus apiå®ç°
    - å¯é€‰æ–¹æ¡ˆè¾ƒå°‘ï¼Œä¸”éœ€è¦é€‚é…ä¸åŒç³»ç»Ÿç‰ˆæœ¬

åŸºäºè¿™äº›éš¾ç‚¹ï¼Œéœ€è¦å¼€å‘é€šçŸ¥æƒé™ç®¡ç†å·¥å…·ç±»ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€ã€å¯é ã€æ˜“ç”¨çš„ç±»åº“ï¼Œæ–¹ä¾¿å¼€å‘è€…åœ¨appå¼€å‘ç›´æ¥è°ƒç”¨ç›¸å…³èƒ½åŠ›ã€‚

---

## ç»„ä»¶åŠŸèƒ½ä»‹ç»

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½æ¨¡å— | æè¿° | æ”¯æŒå¹³å° |
|---------|------|---------|
| **æƒé™æ£€æµ‹** | æ£€æŸ¥å½“å‰åº”ç”¨çš„é€šçŸ¥æƒé™çŠ¶æ€ | iOS |
| **è®¾ç½®é¡µé¢è·³è½¬** | æ™ºèƒ½è·³è½¬åˆ°ç³»ç»Ÿé€šçŸ¥è®¾ç½®é¡µé¢ | Android/iOS |
| **ç‰ˆæœ¬é€‚é…** | é’ˆå¯¹ä¸åŒç³»ç»Ÿç‰ˆæœ¬æä¾›æœ€ä½³è§£å†³æ–¹æ¡ˆ | Android 5.0+, iOS 10+ |

### ğŸš€ ç‰¹è‰²äº®ç‚¹

1. **iOS 18.5+ å®Œç¾é€‚é…**
    - è§£å†³äº†iOS 18.5+ç³»ç»ŸURL Schemeé™åˆ¶é—®é¢˜
    - æä¾›å¤šç§å¤‡ç”¨æ–¹æ¡ˆç¡®ä¿å…¼å®¹æ€§

2. **Androidå…¨ç‰ˆæœ¬æ”¯æŒè·³è½¬**
    - æ”¯æŒAndroid 5.0åˆ°æœ€æ–°ç‰ˆæœ¬
    - æ™ºèƒ½è¯†åˆ«ç³»ç»Ÿç‰ˆæœ¬é€‰æ‹©æœ€ä½³è·³è½¬æ–¹æ¡ˆ

3. **å†…å­˜å®‰å…¨ç®¡ç†**
    - ä½¿ç”¨finallyå—ç¡®ä¿iOSå¯¹è±¡æ­£ç¡®é‡Šæ”¾
    - é¿å…å†…å­˜æ³„æ¼é—®é¢˜

---

### æœªèƒ½å®ç°çš„åŠŸèƒ½
1. **Androidæƒé™æ£€æµ‹æœªå®ç°**
    - Androidç«¯å°è¯•äº†å¤šç§é€šçŸ¥æƒé™æ£€æµ‹çš„æ–¹æ³•ï¼Œä½†å‡æœªå®ç°


## è®¾è®¡æ€è·¯

### ğŸ—ï¸ æ¶æ„è®¾è®¡

```md
NotificationPermissionManager
â”œâ”€â”€ æƒé™æ£€æµ‹æ¨¡å—
â”‚   â”œâ”€â”€ Androidæƒé™æ£€æµ‹
â”‚   â””â”€â”€ iOSæƒé™æ£€æµ‹
â”œâ”€â”€ è®¾ç½®è·³è½¬æ¨¡å—
â”‚   â”œâ”€â”€ Androidè®¾ç½®è·³è½¬
â”‚   â””â”€â”€ iOSè®¾ç½®è·³è½¬
â”‚       â”œâ”€â”€ ç‰ˆæœ¬æ£€æµ‹
â”‚       â”œâ”€â”€ iOS 18+ æ–°æ–¹æ¡ˆ
â”‚       â””â”€â”€ iOS 18ä»¥ä¸‹ æ—§æ–¹æ¡ˆ
â””â”€â”€ æ¨é€ç›‘å¬æ¨¡å—
```

### ğŸ¨ è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£åŸåˆ™**
    - æ¯ä¸ªæ–¹æ³•åªè´Ÿè´£ä¸€ä¸ªå…·ä½“åŠŸèƒ½
    - æƒé™æ£€æµ‹ã€è®¾ç½®è·³è½¬ã€æ¨é€ç›‘å¬åˆ†ç¦»

2. **å¼€é—­åŸåˆ™**
    - å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
    - æ–°å¢å¹³å°æ”¯æŒæ—¶æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 

3. **ä¾èµ–å€’ç½®åŸåˆ™**
    - é¢å‘æ¥å£ç¼–ç¨‹ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
    - é€šè¿‡é…ç½®å’Œç­–ç•¥æ¨¡å¼é€‚é…ä¸åŒå¹³å°

4. **é”™è¯¯ä¼˜å…ˆå¤„ç†**
    - å¼‚å¸¸æƒ…å†µå‰ç½®å¤„ç†
    - æä¾›å®Œå–„çš„é™çº§æ–¹æ¡ˆ

---

## æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹

### ğŸ” 1. è·¨å¹³å°æƒé™æ£€æµ‹

#### Androidæƒé™æ£€æµ‹ï¼ˆæµ‹è¯•æœªé€šè¿‡ï¼‰
```javascript
// æ”¯æŒandroidxå’Œsupportåº“çš„å…¼å®¹
let NotificationManagerCompat = window.plus.android.importClass("android.support.v4.app.NotificationManagerCompat");
if (!NotificationManagerCompat) {
  NotificationManagerCompat = window.plus.android.importClass("androidx.core.app.NotificationManagerCompat");
}
```

- ä¼˜å…ˆå°è¯•androidxåº“ï¼Œç¡®ä¿æ–°ç‰ˆæœ¬å…¼å®¹
- ä½¿ç”¨`areNotificationsEnabled()`æ–¹æ³•æ£€æµ‹æƒé™çŠ¶æ€

#### iOSæƒé™æ£€æµ‹
```javascript
const app = window.plus.ios.invoke('UIApplication', 'sharedApplication');
const settings = window.plus.ios.invoke(app, 'currentUserNotificationSettings');
```

- ä½¿ç”¨`currentUserNotificationSettings`è·å–æƒé™è®¾ç½®
- é€šè¿‡`types`å±æ€§åˆ¤æ–­æƒé™çŠ¶æ€
- åŠæ—¶é‡Šæ”¾iOSå¯¹è±¡é¿å…å†…å­˜æ³„æ¼

### ğŸ¯ 2. iOS 18.5+ é€‚é…æ–¹æ¡ˆ

#### é—®é¢˜åˆ†æ
iOS 18.5+ç³»ç»Ÿå¯¹URL Schemeçš„è°ƒç”¨è¿›è¡Œäº†ä¸¥æ ¼é™åˆ¶ï¼ŒåŸæœ‰çš„`app-settings:`æ–¹æ¡ˆå¤±æ•ˆã€‚

#### è§£å†³æ–¹æ¡ˆ
```javascript
const urlSchemes = [
  'App-prefs:NOTIFICATIONS_ID', // iOS 18+ æ¨èæ–¹å¼
  'prefs:root=NOTIFICATIONS_ID', // å¤‡ç”¨æ–¹å¼1
  'app-settings:', // åŸæœ‰æ–¹å¼ä½œä¸ºå¤‡ç”¨
  'prefs:root=General&path=About' // æœ€åå¤‡ç”¨åˆ°é€šç”¨è®¾ç½®
];
```

- ä½¿ç”¨`canOpenURL:`æ£€æŸ¥URLæœ‰æ•ˆæ€§
- é‡‡ç”¨`openURL:options:completionHandler:`æ–¹æ³•
- å¤šæ–¹æ¡ˆå°è¯•ç¡®ä¿æˆåŠŸç‡

### ğŸ›¡ï¸ 3. å†…å­˜ç®¡ç†ä¼˜åŒ–

#### é—®é¢˜èƒŒæ™¯
iOSå¼€å‘ä¸­ï¼ŒPluså¯¹è±¡éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Œå¦åˆ™ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚

#### è§£å†³æ–¹æ¡ˆ
```javascript
try {
  // iOSè°ƒç”¨é€»è¾‘
} finally {
  // åœ¨finallyå—ä¸­å®‰å…¨æ¸…ç†å¯¹è±¡
  try {
    if (setting) window.plus.ios.deleteObject(setting);
    if (app) window.plus.ios.deleteObject(app);
    if (options) window.plus.ios.deleteObject(options);
  } catch (cleanupError) {
    console.warn('æ¸…ç†iOSå¯¹è±¡æ—¶å‡ºé”™:', cleanupError);
  }
}
```

- ä½¿ç”¨finallyå—ç¡®ä¿å¯¹è±¡æ¸…ç†
- åµŒå¥—try-catché¿å…æ¸…ç†è¿‡ç¨‹ä¸­çš„å¼‚å¸¸
- å˜é‡å£°æ˜åœ¨å¾ªç¯å†…éƒ¨æ§åˆ¶ä½œç”¨åŸŸ

### ğŸ”„ 4. Androidç‰ˆæœ¬é€‚é…

#### ä¸åŒç‰ˆæœ¬çš„Intentå¤„ç†
```javascript
if (Build.VERSION.SDK_INT >= 26) {
  // Android 8.0+
  intent = new Intent('android.settings.APP_NOTIFICATION_SETTINGS');
  intent.putExtra('android.provider.extra.APP_PACKAGE', pkName);
} else if (Build.VERSION.SDK_INT >= 21) {
  // Android 5.0-7.0
  intent = new Intent('android.settings.APP_NOTIFICATION_SETTINGS');
  intent.putExtra("app_package", pkName);
  intent.putExtra("app_uid", uid);
} else {
  // Android 5.0ä»¥ä¸‹
  intent = new Intent();
  intent.setAction(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);
}
```

- æ ¹æ®SDKç‰ˆæœ¬é€‰æ‹©ä¸åŒçš„Intentæ–¹å¼
- ä½¿ç”¨ä¸åŒçš„Extraå‚æ•°ä¼ é€’åº”ç”¨ä¿¡æ¯

---

## ä½¿ç”¨æ–¹æ³•

### ğŸ“¦ å®‰è£…å¯¼å…¥

```javascript
import notificationManager from "@/public/notificationPermission";
```

### ğŸ® åŸºç¡€API

#### 1. æ£€æŸ¥é€šçŸ¥æƒé™
```javascript
const hasPermission = await notificationManager.checkNotificationPermission();
if (hasPermission) {
  console.log("é€šçŸ¥æƒé™å·²å¼€å¯");
} else {
  console.log("é€šçŸ¥æƒé™æœªå¼€å¯");
}
```

#### 2. æ‰“å¼€ç³»ç»Ÿè®¾ç½®
```javascript
// è‡ªåŠ¨è¯†åˆ«å¹³å°å¹¶è·³è½¬
notificationManager.openSystemNotificationSettings();

// æˆ–è€…ç›´æ¥è°ƒç”¨å¹³å°ç‰¹å®šæ–¹æ³•
notificationManager.openIOSNotificationSettings();
notificationManager.openAndroidNotificationSettings();
```

#### 3. è®¾ç½®æ¨é€ç›‘å¬
```javascript
notificationManager.setupPushListeners();
```

### âš™ï¸ å…¶ä»–

#### è‡ªå®šä¹‰Toastæç¤º
```javascript
// è®¾ç½®è‡ªå®šä¹‰Toastæ–¹æ³•
notificationManager.$toast = (message) => {
  // ä½ çš„Toastå®ç°
  console.log(message);
};
```

---

## ä½¿ç”¨æ¡ˆä¾‹

### ğŸ¯ æ¡ˆä¾‹1ï¼šåº”ç”¨å¯åŠ¨æ—¶æƒé™æ£€æŸ¥

```javascript
// åœ¨Appå¯åŠ¨æ—¶æ£€æŸ¥æƒé™
async function checkNotificationOnAppStart() {
  try {
    const hasPermission = await notificationManager.checkNotificationPermission();
    
    if (!hasPermission) {
      // æ˜¾ç¤ºæƒé™è¯·æ±‚å¼¹çª—
      const userConfirm = await showPermissionDialog();
      if (userConfirm) {
        notificationManager.openSystemNotificationSettings();
      }
    } else {
      // è®¾ç½®æ¨é€ç›‘å¬
      notificationManager.setupPushListeners();
    }
  } catch (error) {
    console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
  }
}

function showPermissionDialog() {
  return new Promise((resolve) => {
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    const result = confirm('å¼€å¯é€šçŸ¥æƒé™ä»¥è·å¾—æ›´å¥½çš„ä½¿ç”¨ä½“éªŒï¼Œæ˜¯å¦å‰å¾€è®¾ç½®ï¼Ÿ');
    resolve(result);
  });
}
```

---

## å®Œæ•´ä»£ç 

```javascript
/**
 * @description: é€šçŸ¥æƒé™ç®¡ç†å·¥å…·ç±»
 * @author: hhd 2025-06-18
 * æè¿°ï¼š
 * 1. æ£€æŸ¥é€šçŸ¥æƒé™çŠ¶æ€
 * 2. æ‰“å¼€ç³»ç»Ÿé€šçŸ¥è®¾ç½®é¡µé¢
 * 3. æ‰“å¼€Androidé€šçŸ¥è®¾ç½®
 * 4. æ‰“å¼€iOSé€šçŸ¥è®¾ç½®
 * 5. è®¾ç½®æ¨é€ç›‘å¬å™¨
 * ä½¿ç”¨æ¡ˆä¾‹ï¼š
 * 1. æ£€æŸ¥é€šçŸ¥æƒé™çŠ¶æ€ï¼š
 * import notificationManager from "@/public/notificationPermission";
 * notificationManager.checkNotificationPermission().then(hasPermission => {
 *   if (hasPermission) {
 *     console.log("é€šçŸ¥æƒé™å·²å¼€å¯");
 *   } else {
 *     console.log("é€šçŸ¥æƒé™æœªå¼€å¯");
 *   }
 * });
 * 2. æ‰“å¼€ç³»ç»Ÿé€šçŸ¥è®¾ç½®é¡µé¢ï¼š
 * notificationManager.openSystemNotificationSettings();
 * 3. æ‰“å¼€Androidé€šçŸ¥è®¾ç½®ï¼š
 * notificationManager.openAndroidNotificationSettings();
 * 4. æ‰“å¼€iOSé€šçŸ¥è®¾ç½®ï¼š
 * notificationManager.openIOSNotificationSettings();
 * 5. è®¾ç½®æ¨é€ç›‘å¬å™¨ï¼š
 * notificationManager.setupPushListeners();
 */
class NotificationPermissionManager {
  constructor() {
    this.permissionStatus = null; // æƒé™çŠ¶æ€ç¼“å­˜
  }

  /**
   * æ£€æŸ¥é€šçŸ¥æƒé™çŠ¶æ€
   * @returns {Promise<boolean>} æ˜¯å¦æœ‰æƒé™
   */
  async checkNotificationPermission() {
    return new Promise((resolve) => {
      try {
        if (window.plus.os.name === 'Android') {
          // Android æƒé™æ£€æµ‹
          const main = window.plus.android.runtimeMainActivity();
          let NotificationManagerCompat = window.plus.android.importClass("android.support.v4.app.NotificationManagerCompat");
          
          // android.support.v4å‡çº§ä¸ºandroidx
          if (!NotificationManagerCompat) {
            NotificationManagerCompat = window.plus.android.importClass("androidx.core.app.NotificationManagerCompat");
          }
          
          const areNotificationsEnabled = NotificationManagerCompat.from(main).areNotificationsEnabled();
          this.permissionStatus = areNotificationsEnabled;
          resolve(areNotificationsEnabled);
          
        } else if (window.plus.os.name === 'iOS') {
          // iOS æƒé™æ£€æµ‹
          let isOn = undefined;
          let types = 0;
          const app = window.plus.ios.invoke('UIApplication', 'sharedApplication');
          const settings = window.plus.ios.invoke(app, 'currentUserNotificationSettings');
          
          if (settings) {
            types = settings.plusGetAttribute('types');
            window.plus.ios.deleteObject(settings);
          } else {
            types = window.plus.ios.invoke(app, 'enabledRemoteNotificationTypes');
          }
          
          window.plus.ios.deleteObject(app);
          isOn = (0 != types);
          
          this.permissionStatus = isOn;
          resolve(isOn);
          
        } else {
          // å…¶ä»–å¹³å°é»˜è®¤è¿”å›true
          this.permissionStatus = true;
          resolve(true);
        }

      } catch (error) {
        console.error('æ£€æŸ¥æƒé™å¤±è´¥:', error);
        this.permissionStatus = false;
        resolve(false);
      }
    });
  }


  /**
   * æ‰“å¼€ç³»ç»Ÿé€šçŸ¥è®¾ç½®é¡µé¢
   */
  openSystemNotificationSettings() {
    try {
      if (window.plus.os.name === "Android") {
        this.openAndroidNotificationSettings();
      } else if (window.plus.os.name === "iOS") {
        this.openIOSNotificationSettings();
      }
    } catch (error) {
      console.error('æ‰“å¼€ç³»ç»Ÿè®¾ç½®å¤±è´¥:', error);
      this.$toast("è¯·æ‰‹åŠ¨å‰å¾€ç³»ç»Ÿè®¾ç½®å¼€å¯é€šçŸ¥æƒé™");
    }
  }

  /**
   * æ‰“å¼€Androidé€šçŸ¥è®¾ç½®
   */
  openAndroidNotificationSettings() {
    try {
      const main = window.plus.android.runtimeMainActivity();
      const pkName = main.getPackageName();
      const uid = main.getApplicationInfo().plusGetAttribute("uid");
      const Intent = window.plus.android.importClass('android.content.Intent');
      const Build = window.plus.android.importClass("android.os.Build");
      const Settings = window.plus.android.importClass("android.provider.Settings");
      const Uri = window.plus.android.importClass("android.net.Uri");
      
      let intent;
      
      // android 8.0å¼•å¯¼  
      if (Build.VERSION.SDK_INT >= 26) {
        intent = new Intent('android.settings.APP_NOTIFICATION_SETTINGS');
        intent.putExtra('android.provider.extra.APP_PACKAGE', pkName);
      } else if (Build.VERSION.SDK_INT >= 21) { 
        // android 5.0-7.0  
        intent = new Intent('android.settings.APP_NOTIFICATION_SETTINGS');
        intent.putExtra("app_package", pkName);
        intent.putExtra("app_uid", uid);
      } else { 
        // (<21)å…¶ä»–--è·³è½¬åˆ°è¯¥åº”ç”¨ç®¡ç†çš„è¯¦æƒ…é¡µ  
        intent = new Intent();
        intent.setAction(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);
        const uri = Uri.fromParts("package", pkName, null);
        intent.setData(uri);
      }
      
      // è·³è½¬åˆ°è¯¥åº”ç”¨çš„ç³»ç»Ÿé€šçŸ¥è®¾ç½®é¡µ  
      main.startActivity(intent);
      
    } catch (error) {
      console.error('æ‰“å¼€Androidé€šçŸ¥è®¾ç½®å¤±è´¥:', error);
      this.$toast("è¯·æ‰‹åŠ¨å‰å¾€ç³»ç»Ÿè®¾ç½®å¼€å¯é€šçŸ¥æƒé™");
    }
  }


  /**
   * æ‰“å¼€iOSé€šçŸ¥è®¾ç½®
   */
  openIOSNotificationSettings() {
    try {
      // è·å–iOSç‰ˆæœ¬ä¿¡æ¯
      const iosVersion = this.getIOSVersion();
      console.log('å½“å‰iOSç‰ˆæœ¬:', iosVersion);
      
      // iOS 18+ ä½¿ç”¨æ–°çš„è®¾ç½®URLæ–¹æ¡ˆï¼ˆè°ƒæ•´ç‰ˆæœ¬åˆ¤æ–­ï¼Œ18.0ä»¥ä¸Šéƒ½ä½¿ç”¨æ–°æ–¹æ¡ˆï¼‰
      if (iosVersion >= 18.0) {
        this.openIOSSettingsForNewVersion();
      } else {
        this.openIOSSettingsForOldVersion();
      }
    } catch (error) {
      console.error('æ‰“å¼€iOSé€šçŸ¥è®¾ç½®å¤±è´¥:', error);
      this.showFallbackInstructions();
    }
  }

  /**
   * è·å–iOSç‰ˆæœ¬å·
   */
  getIOSVersion() {
    try {
      const device = window.plus.device;
      const version = parseFloat(device.osver);
      return version;
    } catch (error) {
      console.warn('è·å–iOSç‰ˆæœ¬å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤„ç†æ–¹å¼');
      return 15.0; // é»˜è®¤ç‰ˆæœ¬
    }
  }

  /**
   * iOS 18+ æ–°ç‰ˆæœ¬è®¾ç½®æ‰“å¼€æ–¹å¼
   */
  openIOSSettingsForNewVersion() {
    const urlSchemes = [
      'App-prefs:NOTIFICATIONS_ID', // iOS 18+ æ¨èæ–¹å¼
      'prefs:root=NOTIFICATIONS_ID', // å¤‡ç”¨æ–¹å¼1
      'app-settings:', // åŸæœ‰æ–¹å¼ä½œä¸ºå¤‡ç”¨
      'prefs:root=General&path=About' // æœ€åå¤‡ç”¨åˆ°é€šç”¨è®¾ç½®
    ];

    this.tryOpenWithMultipleSchemes(urlSchemes);
  }

  /**
   * iOS 18ä»¥ä¸‹æ—§ç‰ˆæœ¬è®¾ç½®æ‰“å¼€æ–¹å¼
   */
  openIOSSettingsForOldVersion() {
    const urlSchemes = [
      'app-settings:', // åŸæœ‰æ–¹å¼ä¼˜å…ˆ
      'prefs:root=NOTIFICATIONS_ID',
      'App-prefs:NOTIFICATIONS_ID'
    ];

    this.tryOpenWithMultipleSchemes(urlSchemes);
  }

  /**
   * å°è¯•å¤šç§URL Schemeæ‰“å¼€è®¾ç½®
   */
  tryOpenWithMultipleSchemes(urlSchemes) {
    let success = false;
    
    for (let i = 0; i < urlSchemes.length && !success; i++) {
      let app, setting, options; // å£°æ˜å˜é‡åœ¨å¾ªç¯å†…
      
      try {
        const urlString = urlSchemes[i];
        console.log(`å°è¯•URL Scheme: ${urlString}`);
        
        app = window.plus.ios.invoke('UIApplication', 'sharedApplication');
        setting = window.plus.ios.invoke('NSURL', 'URLWithString:', urlString);
        
        // æ£€æŸ¥URLæ˜¯å¦å¯ä»¥æ‰“å¼€
        const canOpen = window.plus.ios.invoke(app, 'canOpenURL:', setting);
        
        if (canOpen) {
          // iOS 10+ ä½¿ç”¨openURL:options:completionHandler:
          options = window.plus.ios.invoke('NSDictionary', 'dictionary');
          window.plus.ios.invoke(app, 'openURL:options:completionHandler:', setting, options, null);
          success = true;
          console.log(`æˆåŠŸä½¿ç”¨URL Scheme: ${urlString}`);
        } else {
          console.warn(`URL Schemeä¸å¯ç”¨: ${urlString}`);
        }
        
      } catch (error) {
        console.warn(`URL Scheme ${urlSchemes[i]} å¤±è´¥:`, error);
      } finally {
        // åœ¨finallyå—ä¸­å®‰å…¨æ¸…ç†å¯¹è±¡
        try {
          if (setting) window.plus.ios.deleteObject(setting);
          if (app) window.plus.ios.deleteObject(app);
          if (options) window.plus.ios.deleteObject(options);
        } catch (cleanupError) {
          console.warn('æ¸…ç†iOSå¯¹è±¡æ—¶å‡ºé”™:', cleanupError);
        }
      }
    }
    
    if (!success) {
      this.showFallbackInstructions();
    }
  }

  /**
   * æ˜¾ç¤ºå¤‡ç”¨æŒ‡å¼•
   */
  showFallbackInstructions() {
    const iosVersion = this.getIOSVersion();
    let instructions = '';
    
    if (iosVersion >= 18.0) {
      instructions = `æ— æ³•è‡ªåŠ¨æ‰“å¼€è®¾ç½®ï¼Œè¯·æ‰‹åŠ¨æ“ä½œï¼š
        1. æ‰“å¼€ã€è®¾ç½®ã€‘åº”ç”¨
        2. å‘ä¸‹æ»šåŠ¨æ‰¾åˆ°å¹¶ç‚¹å‡»ã€é€šçŸ¥ã€‘
        3. æ‰¾åˆ°å¹¶ç‚¹å‡»ã€${this.getAppName()}ã€‘
        4. å¼€å¯ã€å…è®¸é€šçŸ¥ã€‘å¼€å…³
        5. æ ¹æ®éœ€è¦è®¾ç½®é€šçŸ¥æ ·å¼å’Œå£°éŸ³`;
    } else {
      instructions = "è¯·æ‰‹åŠ¨å‰å¾€ è®¾ç½® -> é€šçŸ¥ -> é€‰æ‹©åº”ç”¨ å¼€å¯æƒé™";
    }
    
    if (this.$toast) {
      this.$toast(instructions);
    } else {
      alert(instructions);
    }
  }

  /**
   * è·å–åº”ç”¨åç§°
   */
  getAppName() {
    try {
      return window.plus.runtime.appid || 'æœ¬åº”ç”¨';
    } catch (error) {
      return 'æœ¬åº”ç”¨';
    }
  }

  /**
   * è®¾ç½®æ¨é€ç›‘å¬å™¨
   */
  setupPushListeners() {
    // ç›‘å¬æ¨é€æ¶ˆæ¯æ¥æ”¶
    window.plus.push.addEventListener('receive', (msg) => {
      console.log('æ”¶åˆ°æ¨é€æ¶ˆæ¯:', msg.content);
    }, false);

    // ç›‘å¬æ¨é€æ¶ˆæ¯ç‚¹å‡»
    window.plus.push.addEventListener('click', (msg) => {
      console.log('ç‚¹å‡»æ¨é€æ¶ˆæ¯:', msg.content);
      // å¤„ç†æ¶ˆæ¯ç‚¹å‡»é€»è¾‘
    }, false);
  }
}

// åˆ›å»ºå•ä¾‹
const notificationManager = new NotificationPermissionManager();

export default notificationManager; 
```


